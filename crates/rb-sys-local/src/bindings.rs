use crate::RbConfig;
use rb_sys_build::bindings::Builder;
use std::cell::RefCell;
use std::fs::File;
use std::ops::DerefMut;
use std::path::PathBuf;
use std::rc::Rc;
use std::{env, error::Error};

pub fn generate(
    rb: &RbConfig,
    static_ruby: bool,
    cfg_out: Rc<RefCell<File>>,
) -> Result<PathBuf, Box<dyn Error>> {
    let out_dir = PathBuf::from(env::var("OUT_DIR").unwrap());
    let ruby_version = rb.ruby_version();
    let target = env::var("TARGET")?;
    let crate_version = env!("CARGO_PKG_VERSION");
    let out_path = format!("bindings-{crate_version}-{target}-{ruby_version}.rs");
    let out_path = out_dir.join(out_path);

    let mut builder = Builder::new()
        .doc_comment(doc_header(rb))
        .print_cargo_directives(true)
        .docs(is_enabled("docs"))
        .deprecated_types(is_enabled("bindgen-deprecated-types"))
        .rbimpls(is_enabled("bindgen-rbimpls"))
        .impl_debug(is_enabled("bindgen-impl-debug"))
        .layout_tests(is_enabled("bindgen-layout-tests"))
        .include(rb.get("rubyhdrdir"))
        .include(rb.get("rubyarchhdrdir"))
        .append_cflags(&rb.cflags())
        .append_cflags(&rb.cppflags());

    // This is needed because bindgen doesn't support the `__declspec(dllimport)` on
    // global variables. Without it, symbols are not found.
    // See https://stackoverflow.com/a/66182704/2057700
    if rb.is_msvc() {
        let libruby = rb.libruby(static_ruby);
        builder = builder.add_link_ruby_directive(libruby);
        builder = builder.exclude_ruby_header("ruby/atomic.h"); // Not supported on mswin
    }

    let bindings = builder.generate()?;

    bindings.write_code_to_file(&out_path)?;
    bindings.write_cargo_cfg_to(cfg_out.borrow_mut().deref_mut())?;
    bindings.write_rustc_cfg_to(&mut std::io::stdout())?;

    Ok(out_path)
}

fn is_enabled(name: &str) -> bool {
    let name = name.replace('-', "_");
    env::var_os(format!("CARGO_FEATURE_{}", name.to_uppercase())).is_some()
}

fn doc_header(rb_config: &RbConfig) -> String {
    format!(
        "// Generated by [rb-sys]({}) for Ruby {} ({}).\n\n",
        env!("CARGO_PKG_REPOSITORY"),
        rb_config.ruby_version(),
        rb_config.platform()
    )
}
